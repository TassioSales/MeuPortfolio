{% extends "base.html" %}

{% block title %}Início{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Estilos para a aba de tempo real */
#resultadoAtivo {
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
}

#resultadoAtivo.fade-in {
    opacity: 1;
    transform: translateY(0);
}

/* Estilo para o card de informações do ativo */
.card-ativo {
    border-radius: 0.5rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    margin-bottom: 1.5rem;
}

/* Estilo para o preço do ativo */
.ativo-preco {
    font-size: 2rem;
    font-weight: 700;
    color: #2e59d9;
}

/* Estilo para a variação do preço */
.ativo-variacao {
    font-size: 1.1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.ativo-variacao .bi {
    transition: transform 0.2s ease;
}

.ativo-variacao:hover .bi-arrow-up {
    transform: translateY(-2px);
}

.ativo-variacao:hover .bi-arrow-down {
    transform: translateY(2px);
}

/* Estilo para os cards de informações adicionais */
.info-card {
    border-left: 0.25rem solid #4e73df;
    border-radius: 0.35rem;
    background-color: #f8f9fc;
    padding: 1rem;
    margin-bottom: 1rem;
}

.info-card h6 {
    color: #4e73df;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

/* Estilo para o formulário de adicionar ativo */
#formAdicionarAtivo .form-control:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

/* Estilos para o gráfico */
#graficoAtivo {
    width: 100%;
    min-height: 300px;
    position: relative;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
}

#graficoAtivo.carregado {
    opacity: 1;
    transform: translateY(0);
}

/* Animações */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.fade-in {
    animation: fadeIn 0.3s ease forwards;
}

.slide-in {
    animation: slideIn 0.4s ease forwards;
}

/* Efeito de onda para placeholders */
.placeholder-wave {
    position: relative;
    overflow: hidden;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    color: transparent;
    user-select: none;
    pointer-events: none;
}

.placeholder-wave::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        rgba(0, 0, 0, 0) 0%, 
        rgba(0, 0, 0, 0.05) 50%, 
        rgba(0, 0, 0, 0) 100%);
    animation: placeholderWave 1.5s ease-in-out infinite;
    z-index: 1;
}

@keyframes placeholderWave {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Melhorias no feedback visual durante o carregamento */
#graficoAtivo {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fc;
    border-radius: 0.5rem;
    position: relative;
    overflow: hidden;
}

/* Estilo para o spinner de carregamento */
.chart-loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 0.3rem solid rgba(78, 115, 223, 0.1);
    border-radius: 50%;
    border-top-color: #4e73df;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Transições suaves para elementos que aparecem/desaparecem */
.fade-enter-active, .fade-leave-active {
    transition: opacity 0.3s ease;
}

.fade-enter-from, .fade-leave-to {
    opacity: 0;
}

/* Melhorias na acessibilidade para usuários que preferem redução de movimento */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
    
    .placeholder-wave::after {
        animation: none !important;
    }
}

/* Estilo para mensagens de aviso */
#ativoAviso {
    display: none;
    margin-top: 1rem;
    border-radius: 0.5rem;
}

/* Estilo para o botão de busca */
#btnBuscarAtivo {
    min-width: 100px;
    position: relative;
}

/* Estilos para o indicador de carregamento */
.spin {
    animation: spin 1s linear infinite;
    display: inline-block;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Estilo para o placeholder de carregamento */
.placeholder-wave {
    display: inline-block;
    min-height: 1em;
    background-color: #e9ecef;
    opacity: 0.5;
    border-radius: 0.25rem;
    animation: placeholder-wave 2s ease-in-out infinite;
}

@keyframes placeholder-wave {
    0% { opacity: 0.5; }
    50% { opacity: 0.7; }
    100% { opacity: 0.5; }
}

/* Melhorias na exibição de erros */
.alert-dismissible {
    border-radius: 0.5rem;
}

/* Melhorias na responsividade */
@media (max-width: 768px) {
    .ativo-preco {
        font-size: 1.75rem;
    }
    
    .info-card {
        padding: 0.75rem;
    }
    
    .nav-tabs .nav-link {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
}

/* Melhorias na exibição do gráfico */
.plotly-graph-div {
    width: 100% !important;
}

/* Melhorias na exibição de valores */
.valor-destaque {
    font-size: 1.5rem;
    font-weight: 600;
}

.rotulo-valor {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

/* Melhorias no formulário de busca */
.search-container {
    position: relative;
}

.search-container .btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 5;
}

.search-container .form-control {
    padding-right: 50px;
}

/* Estilo para os cards de informação */
.info-card {
    transition: all 0.3s ease;
}

.info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
}

/* Estilo para o preço atual */
#ativoPreco {
    font-size: 2.25rem;
    font-weight: 700;
    color: #2e59d9;
}

/* Estilo para a seção de informações específicas */
#infoEspecifica {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.25rem;
    margin-top: 1.5rem;
}

/* Estilo para o botão de adicionar ativo */
#btnAdicionarAtivo:disabled {
    cursor: not-allowed;
    opacity: 0.7;
}

/* Estilo para o spinner de carregamento no botão */
.btn-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 0.2em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
    margin-right: 0.5rem;
    vertical-align: -0.125em;
    transition: opacity 0.2s ease;
}

/* Melhorias no feedback tátil */
.btn {
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.btn:active {
    transform: translateY(1px);
}

.btn:focus {
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

/* Efeito de ripple nos botões */
.btn-ripple {
    position: relative;
    overflow: hidden;
}

.btn-ripple:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%, -50%);
    transform-origin: 50% 50%;
}

.btn-ripple:focus:not(:active)::after {
    animation: ripple 0.6s ease-out;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(40, 40);
        opacity: 0;
    }
}

/* Melhorias nos inputs */
.form-control {
    transition: all 0.2s ease;
}

.form-control:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

/* Feedback visual para cards */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
}

/* Melhorias na acessibilidade para foco */
:focus-visible {
    outline: 2px solid #4e73df;
    outline-offset: 2px;
    border-radius: 0.25rem;
}

/* Melhorias na navegação por teclado */
[tabindex="0"]:focus, button:focus, a:focus, input:focus, select:focus, textarea:focus {
    position: relative;
    z-index: 1;
}

/* Estilos para o histórico de buscas */
.historico-item {
    transition: all 0.2s ease;
    border: 1px solid transparent;
    margin: 2px 0;
    cursor: pointer;
    border-radius: 4px;
}

/* Estilos para o spinner de carregamento do gráfico */
.chart-loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(13, 110, 253, 0.2);
    border-radius: 50%;
    border-top-color: #0d6efd;
    animation: spin 1s ease-in-out infinite;
    position: relative;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Estilos para animações de entrada */
.fade-in {
    animation: fadeIn 0.4s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Estilos para o efeito de onda nos placeholders */
.placeholder-wave {
    position: relative;
    overflow: hidden;
    background-color: #e9ecef;
    border-radius: 4px;
}

.placeholder-wave::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: placeholderWave 1.5s infinite;
}

@keyframes placeholderWave {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Melhorias na acessibilidade para foco */
.historico-item:focus {
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}

/* Efeito de hover para itens clicáveis */
.historico-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
}

.historico-item:active {
    transform: translateX(0);
    transition: transform 0.1s;
}

.historico-item:hover {
    background-color: #f8f9fa !important;
    border-color: #dee2e6;
    transform: translateX(2px);
}

.historico-item:active {
    background-color: #e9ecef !important;
    transform: translateX(0);
}

/* Estilo para scrollbar personalizada */
#historicoBuscas::-webkit-scrollbar {
    width: 6px;
}

#historicoBuscas::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#historicoBuscas::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#historicoBuscas::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                <i class="bi bi-house-door"></i> Visão Geral
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="realtime-tab" data-bs-toggle="tab" data-bs-target="#realtime" type="button" role="tab" aria-controls="realtime" aria-selected="false">
                <i class="bi bi-graph-up"></i> Tempo Real
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="mainTabsContent">
        <!-- Aba de Visão Geral -->
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2 class="h4">Resumo da Carteira</h2>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="{{ url_for('adicionar_ativo') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> Adicionar Ativo
                    </a>
                </div>
            </div>

    <!-- Cards de Resumo -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Valor Total Investido</h5>
                    <h3 class="card-text">R$ {{ "%0.2f"|format(resumo.total_investido|float|default(0.0)) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Valor Atual</h5>
                    <h3 class="card-text">R$ {{ "%0.2f"|format(resumo.valor_atual|float|default(0.0)) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Resultado</h5>
                    <h3 class="card-text {% if resumo.resultado_bruto|float >= 0 %}text-success{% else %}text-danger{% endif %}">
                        R$ {{ "%0.2f"|format(resumo.resultado_bruto|float|default(0.0)) }}
                        <small class="fs-6">({{ "%0.2f"|format(resumo.resultado_percentual|float|default(0.0)) }}%)</small>
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Distribuição por Tipo -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Distribuição por Tipo</h5>
                </div>
                <div class="card-body">
                    <div id="graficoDistribuicao" style="height: 300px;">
                        {% if not resumo.distribuicao_tipos %}
                        <p class="text-center text-muted my-5">Nenhum dado de distribuição disponível</p>
                        {% else %}
                        <p class="text-center text-muted my-5 d-none">Carregando gráfico de distribuição...</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Ativos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ativo</th>
                                    <th class="text-end">Valor</th>
                                    <th class="text-end">% Carteira</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set ativos_ordenados = resumo.ativos_detalhados|sort(attribute='valor_atual', reverse=true) %}
                                {% for ativo in ativos_ordenados[:5] %}
                                <tr>
                                    <td>
                                        <strong>{{ ativo.ticker|default('N/A') }}</strong><br>
                                        <small class="text-muted">{{ (ativo.nome|default('N/A'))[:20] }}{% if ativo.nome|length > 20 %}...{% endif %}</small>
                                    </td>
                                    <td class="text-end">R$ {{ "%0.2f"|format(ativo.valor_atual|float|default(0.0)) }}</td>
                                    <td class="text-end">
                                        {% if resumo.valor_atual|float > 0 %}
                                        {{ "%0.1f"|format((ativo.valor_atual|float / resumo.valor_atual|float * 100)|default(0.0)) }}%
                                        {% else %}
                                        0.0%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhum ativo cadastrado. Adicione ativos para visualizar.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
        
        <!-- Aba de Tempo Real -->
        <div class="tab-pane fade" id="realtime" role="tabpanel" aria-labelledby="realtime-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Buscar Ativo em Tempo Real</h5>
                            <div id="ativoAviso" class="alert d-none mb-3" role="alert"></div>
                            <div class="search-container mb-4">
                                <div class="input-group">
                                    <input 
                                        type="text" 
                                        class="form-control form-control-lg" 
                                        id="buscaAtivo" 
                                        placeholder="Ex: PETR4.SA, HGLG11.SA, BOVA11.SA, BTC-USD, USD-BRL" 
                                        aria-label="Buscar ativo"
                                        autocomplete="off"
                                    >
                                    <button class="btn btn-primary" type="button" id="btnBuscarAtivo">
                                        <span id="btnBuscarText">Buscar</span>
                                        <span class="spinner-border spinner-border-sm d-none" id="btnBuscarSpinner" role="status" aria-hidden="true"></span>
                                    </button>
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-collection"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="sugestoesAtivos" style="max-height: 500px; overflow-y: auto;">
                                        <!-- Ações Brasileiras -->
                                        <li><h6 class="dropdown-header">Ações Brasileiras</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="PETR4.SA">PETR4.SA - Petrobras</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="VALE3.SA">VALE3.SA - Vale</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="ITUB4.SA">ITUB4.SA - Itaú Unibanco</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="BBDC4.SA">BBDC4.SA - Bradesco</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="BBAS3.SA">BBAS3.SA - Banco do Brasil</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="B3SA3.SA">B3SA3.SA - B3</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="WEGE3.SA">WEGE3.SA - Weg</a></li>
                                        
                                        <li class="dropdown-divider"></li>
                                        <!-- Fundos Imobiliários -->
                                        <li><h6 class="dropdown-header">Fundos Imobiliários</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="HGLG11.SA">HGLG11.SA - CSHG Logística</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="MXRF11.SA">MXRF11.SA - Maxi Renda</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="KNRI11.SA">KNRI11.SA - Kinea Renda Imobiliária</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="HGBS11.SA">HGBS11.SA - Hedge Shopping</a></li>
                                        
                                        <li class="dropdown-divider"></li>
                                        <!-- ETFs -->
                                        <li><h6 class="dropdown-header">ETFs</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="BOVA11.SA">BOVA11.SA - Ibovespa</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="IVVB11.SA">IVVB11.SA - S&P 500</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="SMAL11.SA">SMAL11.SA - Small Caps</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="XBOV11.SA">XBOV11.SA - Ibovespa com Cobertura</a></li>
                                        
                                        <li class="dropdown-divider"></li>
                                        <!-- Renda Fixa -->
                                        <li><h6 class="dropdown-header">Renda Fixa</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="SELIC">SELIC - Taxa Básica de Juros</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="CDI">CDI - Certificado de Depósito Interbancário</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="IPCA">IPCA - Índice de Preços</a></li>
                                        
                                        <li class="dropdown-divider"></li>
                                        <!-- Criptomoedas -->
                                        <li><h6 class="dropdown-header">Criptomoedas</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="BTC-USD">BTC-USD - Bitcoin</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="ETH-USD">ETH-USD - Ethereum</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="USDT-USD">USDT-USD - Tether</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="BNB-USD">BNB-USD - Binance Coin</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="XRP-USD">XRP-USD - Ripple</a></li>
                                        
                                        <li class="dropdown-divider"></li>
                                        <!-- Moedas -->
                                        <li><h6 class="dropdown-header">Moedas</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="USD-BRL">USD-BRL - Dólar Americano</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="EUR-BRL">EUR-BRL - Euro</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="GBP-BRL">GBP-BRL - Libra Esterlina</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="BTC-BRL">BTC-BRL - Bitcoin</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="ETH-BRL">ETH-BRL - Ethereum</a></li>
                                        
                                        <li class="dropdown-divider"></li>
                                        <!-- Índices -->
                                        <li><h6 class="dropdown-header">Índices</h6></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="^BVSP">^BVSP - IBOVESPA</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="^GSPC">^GSPC - S&P 500</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="^IXIC">^IXIC - NASDAQ</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="^DJI">^DJI - Dow Jones</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="^FTSE">^FTSE - FTSE 100</a></li>
                                        <li><a class="dropdown-item" href="#" data-ticker="^N225">^N225 - Nikkei 225</a></li>
                                    </ul>
                                </div>
                                <div id="sugestoesBuscas" class="dropdown-menu p-3" style="width: 100%; max-height: 300px; overflow-y: auto; display: none;">
                                    <a href="#" class="badge bg-light text-dark text-decoration-none" data-ticker="PETR4.SA">PETR4.SA</a>
                                    <a href="#" class="badge bg-light text-dark text-decoration-none" data-ticker="BTC-USD">BTC-USD</a>
                                    <a href="#" class="badge bg-light text-dark text-decoration-none" data-ticker="USD-BRL">USD-BRL</a>
                                    <a href="#" class="badge bg-light text-dark text-decoration-none" data-ticker="VALE3.SA">VALE3.SA</a>
                                </div>
                                
                                <!-- Histórico de Buscas -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">Buscas Recentes</h6>
                                        <button id="btnLimparHistorico" class="btn btn-sm btn-link text-decoration-none p-0" 
                                                title="Limpar histórico">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <div id="historicoItens" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-muted" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <div class="small text-muted mt-2">Carregando histórico...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resultado da Busca -->
            <div id="resultadoAtivo" class="d-none">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Informações do Ativo</h5>
                                <span class="badge bg-secondary" id="ativoTipo">Tipo</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h3 class="mb-0" id="ativoNome">-</h3>
                                        <span class="text-muted" id="ativoTicker">-</span>
                                    </div>
                                    <div class="text-end">
                                        <h3 class="mb-0" id="ativoPreco">-</h3>
                                        <span class="badge" id="ativoVariacao">
                                            <i class="bi bi-arrow-up"></i> 0.00%
                                        </span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Mín. do Dia:</td>
                                                <td class="text-end" id="ativoMinDia">-</td>
                                            </tr>
                                            <tr>
                                                <td>Máx. do Dia:</td>
                                                <td class="text-end" id="ativoMaxDia">-</td>
                                            </tr>
                                            <tr>
                                                <td>Abertura:</td>
                                                <td class="text-end" id="ativoAbertura">-</td>
                                            </tr>
                                            <tr>
                                                <td>Fech. Anterior:</td>
                                                <td class="text-end" id="ativoFechamentoAnterior">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Volume (24h):</td>
                                                <td class="text-end" id="ativoVolume">-</td>
                                            </tr>
                                            <tr>
                                                <td>Volume Médio:</td>
                                                <td class="text-end" id="ativoVolumeMedio">-</td>
                                            </tr>
                                            <tr>
                                                <td>Valor de Mercado:</td>
                                                <td class="text-end" id="ativoMarketCap">-</td>
                                            </tr>
                                            <tr>
                                                <td>Última Atualização:</td>
                                                <td class="text-end" id="ativoAtualizacao">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Informações Específicas -->
                                <div class="mt-4" id="infoEspecifica">
                                    <h6>Informações Específicas</h6>
                                    <div id="infoAcoes" class="d-none">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td>Setor:</td>
                                                        <td class="text-end" id="ativoSetor">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Dividend Yield:</td>
                                                        <td class="text-end" id="ativoDividendYield">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>P/L:</td>
                                                        <td class="text-end" id="ativoPL">-</td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td>LPA:</td>
                                                        <td class="text-end" id="ativoLPA">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Dívida Líquida:</td>
                                                        <td class="text-end" id="ativoDividaLiquida">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>EBITDA:</td>
                                                        <td class="text-end" id="ativoEbitda">-</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted" id="ativoDescricao"></small>
                                        </div>
                                    </div>
                                    
                                    <div id="infoCripto" class="d-none">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td>Fornec. Circulante:</td>
                                                        <td class="text-end" id="ativoFornecimentoCirc">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Fornec. Total:</td>
                                                        <td class="text-end" id="ativoFornecimentoTotal">-</td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td>Fornec. Máx:</td>
                                                        <td class="text-end" id="ativoFornecimentoMax">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Variação 24h:</td>
                                                        <td class="text-end" id="ativoVariacao24h">-</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Gráfico de Preços (30 dias)</h5>
                            </div>
                            <div class="card-body">
                                <div id="graficoAtivo" style="height: 300px;">
                                    <p class="text-center text-muted my-5">Carregando gráfico...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Adicionar à Carteira</h5>
                            </div>
                            <div class="card-body">
                                <form id="formAdicionarAtivo">
                                    <input type="hidden" id="tickerAtivo" name="ticker">
                                    <div class="mb-3">
                                        <label for="quantidade" class="form-label">Quantidade</label>
                                        <input type="number" class="form-control" id="quantidade" name="quantidade" step="0.00000001" min="0.00000001" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="precoMedio" class="form-label">Preço Médio (opcional)</label>
                                        <input type="number" class="form-control" id="precoMedio" name="preco_medio" step="0.01" min="0">
                                        <div class="form-text">Deixe em branco para usar o preço atual.</div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-plus-circle"></i> Adicionar à Carteira
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mensagem Inicial -->
            <div id="mensagemInicial" class="text-center text-muted py-5">
                <i class="bi bi-graph-up" style="font-size: 3rem; opacity: 0.5;"></i>
                <h4 class="mt-3">Busque por um ativo para começar</h4>
                <p>Digite o código do ativo (ex: PETR4.SA, BTC-USD, USD-BRL) e clique em buscar.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ativo Adicionado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>O ativo foi adicionado à sua carteira com sucesso!</p>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('listar_ativos') }}" class="btn btn-primary">Ver Carteira</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuar</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    // Dados para o gráfico de distribuição
    {% if resumo.distribuicao_tipos %}
    const dadosDistribuicao = {
        values: [
            {% for item in resumo.distribuicao_tipos %}
                {{ item.valor|float|default(0.0) }}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        labels: [
            {% for item in resumo.distribuicao_tipos %}
                '{{ item.tipo|default('N/A') }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        type: 'pie',
        textinfo: 'label+percent',
        textposition: 'inside',
        hoverinfo: 'label+percent+value',
        hole: 0.4,
        marker: {
            colors: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997']
        }
    };

    const layout = {
        margin: { t: 10, b: 10, l: 10, r: 10 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 },
        height: 300
    };

    // Renderiza o gráfico
    Plotly.newPlot('graficoDistribuicao', [dadosDistribuicao], layout);

    // Atualiza o gráfico quando a janela for redimensionada
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('graficoDistribuicao');
    });
    {% else %}
    // Esconde a mensagem de carregamento se não houver dados
    document.querySelector('#graficoDistribuicao .text-muted').classList.remove('d-none');
    {% endif %}
</script>

<script>
// Funções para formatação
function formatarMoeda(valor, moeda = 'BRL') {
    if (valor === null || valor === undefined) return 'N/A';
    
    const numero = parseFloat(valor);
    if (isNaN(numero)) return 'N/A';
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: moeda,
        minimumFractionDigits: 2,
        maximumFractionDigits: 10
    }).format(numero);
}

function formatarNumero(valor, casasDecimais = 2) {
    if (valor === null || valor === undefined) return 'N/A';
    
    const numero = parseFloat(valor);
    if (isNaN(numero)) return 'N/A';
    
    return numero.toLocaleString('pt-BR', {
        minimumFractionDigits: casasDecimais,
        maximumFractionDigits: casasDecimais
    });
}

// Função para atualizar o estado do botão de busca
function atualizarEstadoBusca(carregando) {
    const btnBuscar = document.getElementById('btnBuscarAtivo');
    const btnBuscarText = document.getElementById('btnBuscarText');
    const btnBuscarSpinner = document.getElementById('btnBuscarSpinner');
    const inputBusca = document.getElementById('buscaAtivo');
    
    if (btnBuscar) {
        // Atualiza o estado do botão
        btnBuscar.disabled = carregando;
        
        if (carregando) {
            // Estado de carregamento ativo
            btnBuscar.setAttribute('aria-busy', 'true');
            btnBuscarText.textContent = 'Buscando...';
            btnBuscarSpinner.classList.remove('d-none');
            
            // Adiciona classe para feedback visual
            btnBuscar.classList.add('pe-none');
            
            // Desabilita o input durante a busca
            if (inputBusca) {
                inputBusca.disabled = true;
                inputBusca.setAttribute('aria-busy', 'true');
            }
        } else {
            // Estado de carregamento inativo
            btnBuscar.setAttribute('aria-busy', 'false');
            btnBuscarText.textContent = 'Buscar';
            btnBuscarSpinner.classList.add('d-none');
            
            // Remove classe de feedback visual
            btnBuscar.classList.remove('pe-none');
            
            // Habilita o input após a busca
            if (inputBusca) {
                inputBusca.disabled = false;
                inputBusca.setAttribute('aria-busy', 'false');
                
                // Foca no input para facilitar nova busca
                setTimeout(() => {
                    inputBusca.focus();
                }, 100);
            }
        }
    }
}

// Inicialização da aba de tempo real
document.addEventListener('DOMContentLoaded', function() {
    const btnBuscar = document.getElementById('btnBuscarAtivo');
    const inputBusca = document.getElementById('buscaAtivo');
    const sugestoesAtivos = document.getElementById('sugestoesAtivos');
    const sugestoesBuscas = document.getElementById('sugestoesBuscas');
    const historicoItens = document.getElementById('historicoItens');
    const limparHistoricoBtn = document.getElementById('btnLimparHistorico');
    
    // Carregar histórico de buscas ao iniciar
    carregarHistoricoBuscas();
    
    // Mostrar/ocultar histórico ao clicar no campo de busca
    if (inputBusca) {
        inputBusca.addEventListener('focus', function() {
            if (sugestoesBuscas) {
                const historico = JSON.parse(localStorage.getItem('historicoBuscas') || '[]');
                if (historico.length > 0) {
                    sugestoesBuscas.style.display = 'block';
                }
            }
        });
        
        inputBusca.addEventListener('blur', function() {
            // Pequeno atraso para permitir o clique nos itens do histórico
            setTimeout(() => {
                if (sugestoesBuscas) {
                    sugestoesBuscas.style.display = 'none';
                }
            }, 200);
        });
    }
    
    // Manipular clique nas sugestões de ativos
    if (sugestoesAtivos) {
        sugestoesAtivos.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const ticker = this.getAttribute('data-ticker');
                if (ticker && inputBusca) {
                    inputBusca.value = ticker;
                    buscarAtivo();
                }
            });
        });
    }
    
    // Limpar histórico de buscas
    if (limparHistoricoBtn) {
        limparHistoricoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            limparHistoricoBuscas();
        });
    }
    
    // Evento de clique nos itens do histórico
    document.addEventListener('click', function(e) {
        if (e.target.closest('.historico-item')) {
            e.preventDefault();
            const item = e.target.closest('.historico-item');
            const ticker = item.getAttribute('data-ticker');
            const inputBusca = document.getElementById('buscaAtivo');
            if (ticker && inputBusca) {
                inputBusca.value = ticker;
                buscarAtivo();
            }
        }
    });
    
    // Evento para o botão de limpar histórico no modal
    const btnLimparModal = document.getElementById('btnLimparHistorico');
    if (btnLimparModal) {
        btnLimparModal.addEventListener('click', function(e) {
            e.preventDefault();
            limparHistoricoBuscas();
        });
    }
    
    const formAdicionar = document.getElementById('formAdicionarAtivo');
    const btnBuscarIcon = document.getElementById('btnBuscarIcon');
    const btnBuscarText = document.getElementById('btnBuscarText');
    const ativoAviso = document.getElementById('ativoAviso');
    const btnLimparHistorico = document.getElementById('btnLimparHistorico');
    
    // Carrega o histórico de buscas
    carregarHistoricoBuscas();
    
    // Configura o botão de limpar histórico
    if (btnLimparHistorico) {
        btnLimparHistorico.addEventListener('click', function(e) {
            e.stopPropagation();
            limparHistoricoBuscas();
        });
    }
    
    // Evento de clique no botão de busca
    if (btnBuscar) {
        btnBuscar.addEventListener('click', function() {
            buscarAtivo();
        });
    }
    
    // Evento de pressionar Enter no campo de busca
    if (inputBusca) {
        inputBusca.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarAtivo();
            }
        });
        
        // Foco automático no campo de busca
        inputBusca.focus();
        
        // Limpa mensagens de erro ao começar a digitar
        inputBusca.addEventListener('input', function() {
            if (ativoAviso && !ativoAviso.classList.contains('d-none')) {
                ativoAviso.classList.add('d-none');
            }
        });
    }
    
    // Evento de clique nas sugestões rápidas
    document.querySelectorAll('[data-ticker]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const ticker = this.getAttribute('data-ticker');
            if (inputBusca) {
                inputBusca.value = ticker;
                buscarAtivo();
            }
        });
    });
    
    // Evento de submit do formulário de adicionar ativo
    if (formAdicionar) {
        formAdicionar.addEventListener('submit', function(e) {
            e.preventDefault();
            adicionarAtivoACarteira();
        });
    }
    
    // Verifica se há um ativo na URL (para compartilhamento)
    const urlParams = new URLSearchParams(window.location.search);
    const ativoParam = urlParams.get('ativo');
    if (ativoParam && inputBusca) {
        inputBusca.value = ativoParam;
        buscarAtivo();
    }
});

// Função para buscar informações do ativo
async function buscarAtivo() {
    const inputBusca = document.getElementById('buscaAtivo');
    const resultadoDiv = document.getElementById('resultadoAtivo');
    const ativoAviso = document.getElementById('ativoAviso');
    const btnBuscar = document.getElementById('btnBuscarAtivo');
    const graficoContainer = document.getElementById('graficoAtivo');
    
    if (!inputBusca || !resultadoDiv || !btnBuscar) return;
    
    const ticker = inputBusca.value.trim().toUpperCase();
    
    // Validação do input
    if (!ticker) {
        mostrarAviso('Por favor, insira um código de ativo válido.', 'warning');
        inputBusca.focus();
        return;
    }
    
    try {
        // Atualiza o estado do botão para carregando
        atualizarEstadoBusca(true);
        
        // Limpa mensagens de erro anteriores e esconde o resultado anterior
        if (ativoAviso) ativoAviso.classList.add('d-none');
        if (resultadoDiv) resultadoDiv.classList.add('d-none');
        
        // Mostra um placeholder de carregamento no container do gráfico
        if (graficoContainer) {
            graficoContainer.innerHTML = `
                <div class="d-flex flex-column justify-content-center align-items-center" style="height: 300px;">
                    <div class="chart-loading-spinner mb-3"></div>
                    <div class="text-muted">Buscando dados do ativo...</div>
                </div>
            `;
        }
        
        // Adiciona um pequeno atraso para garantir que o placeholder seja exibido
        await new Promise(resolve => setTimeout(resolve, 50));
        
        // Configura o timeout para a requisição
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos de timeout
        
        // Atualiza a URL para permitir compartilhamento
        const url = new URL(window.location);
        url.searchParams.set('ativo', ticker);
        window.history.pushState({}, '', url);
        
        // Adiciona um timestamp para evitar cache do navegador
        const timestamp = new Date().getTime();
        
        // Faz a requisição para a API
        const response = await fetch(`/api/ativo/${encodeURIComponent(ticker)}/info?t=${timestamp}`, {
            signal: controller.signal,
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        
        clearTimeout(timeoutId);
        
        // Verifica se a resposta foi bem-sucedida
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.erro || `Erro na requisição: ${response.status} ${response.statusText}`;
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        // Verifica se há dados válidos
        if (!data || !data.dados) {
            throw new Error('Dados do ativo não encontrados ou inválidos');
        }
        
        // Exibe os dados do ativo com animação
        exibirDadosAtivo(data);
        
        // Mostra a seção de resultados com animação
        if (resultadoDiv) {
            resultadoDiv.classList.remove('d-none');
            resultadoDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Atualiza o título da página
        document.title = `${data.dados.nome || ticker} - ${formatarMoeda(data.dados.preco_atual, data.dados.moeda)} | Gerenciador de Ativos`;
        
        // Adiciona ao histórico de buscas
        adicionarAoHistoricoBusca(ticker, data.dados.nome || ticker);
        
        // Mostra mensagem de sucesso
        mostrarAviso(`Dados de ${data.dados.nome || ticker} carregados com sucesso!`, 'success', 3000);
        
    } catch (error) {
        console.error('Erro ao buscar ativo:', error);
        
        // Mensagens de erro mais amigáveis e específicas
        let mensagemErro = 'Ocorreu um erro ao buscar as informações do ativo.';
        let tipoErro = 'danger';
        
        if (error.name === 'AbortError') {
            mensagemErro = 'A requisição demorou muito para responder. Por favor, verifique sua conexão e tente novamente.';
            tipoErro = 'warning';
        } else if (error.message.includes('404') || error.message.includes('não encontrado')) {
            mensagemErro = `Ativo "${ticker}" não encontrado. Verifique o código e tente novamente.`;
            tipoErro = 'warning';
        } else if (error.message.includes('rede') || error.message.includes('conexão')) {
            mensagemErro = 'Erro de conexão. Verifique sua internet e tente novamente.';
            tipoErro = 'danger';
        } else {
            mensagemErro = error.message || mensagemErro;
        }
        
        // Exibe mensagem de erro para o usuário
        mostrarAviso(mensagemErro, tipoErro);
        
        // Limpa o container do gráfico em caso de erro
        if (graficoContainer) {
            graficoContainer.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center py-5">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2.5rem;"></i>
                    <div class="mt-3 text-muted">Não foi possível carregar o gráfico</div>
                </div>
            `;
        }
        
        // Mostra a mensagem inicial se estiver oculta
        const mensagemInicial = document.getElementById('mensagemInicial');
        if (mensagemInicial && mensagemInicial.classList.contains('d-none')) {
            mensagemInicial.classList.remove('d-none');
            mensagemInicial.classList.add('fade-in');
        }
        
        // Esconde a seção de resultados
        if (resultadoDiv) {
            resultadoDiv.classList.add('d-none');
        }
        
        // Restaura o título da página em caso de erro
        document.title = 'Buscar Ativo | Gerenciador de Ativos';
        
    } finally {
        // Restaura o estado do botão independentemente do resultado
        atualizarEstadoBusca(false);
        
        // Foca no campo de busca para facilitar uma nova pesquisa
        inputBusca.focus();
    }
}

// Função para adicionar ao histórico de buscas
function adicionarAoHistoricoBusca(ticker, nome) {
    // Verificar se já existe no histórico
    const historico = JSON.parse(localStorage.getItem('historicoBuscas') || '[]');
    
    // Remover se já existir
    const index = historico.findIndex(item => item.ticker === ticker);
    if (index !== -1) {
        historico.splice(index, 1);
    }
    
    // Adicionar no início do array
    historico.unshift({ ticker, nome, data: new Date().toISOString() });
    
    // Manter apenas os 10 itens mais recentes
    const historicoAtualizado = historico.slice(0, 10);
    
    // Salvar no localStorage
    localStorage.setItem('historicoBuscas', JSON.stringify(historicoAtualizado));
    
    // Atualizar a exibição
    atualizarExibicaoHistorico(historicoAtualizado);
}

// Função para atualizar a exibição do histórico
function atualizarExibicaoHistorico(historico) {
    const historicoItens = document.getElementById('historicoItens');
    if (!historicoItens) return;
    
    if (historico.length === 0) {
        historicoItens.innerHTML = '<div class="text-muted small">Nenhuma busca recente</div>';
        return;
    }
    
    historicoItens.innerHTML = historico.map(item => {
        const data = new Date(item.data);
        const dataFormatada = data.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `
            <a href="#" class="d-block py-1 text-decoration-none text-dark historico-item" 
               data-ticker="${item.ticker}" title="${item.nome}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-medium">${item.ticker}</div>
                    <small class="text-muted">${dataFormatada}</small>
                </div>
                <div class="small text-truncate text-muted" style="max-width: 200px;">
                    ${item.nome || ''}
                </div>
            </a>
        `;
    }).join('');
    
    // Adicionar eventos aos itens do histórico
    document.querySelectorAll('.historico-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const ticker = this.getAttribute('data-ticker');
            const inputBusca = document.getElementById('buscaAtivo');
            if (ticker && inputBusca) {
                inputBusca.value = ticker;
                buscarAtivo();
            }
        });
    });
}

// Função para carregar o histórico de buscas
function carregarHistoricoBuscas() {
    try {
        const historico = JSON.parse(localStorage.getItem('historicoBuscas') || '[]');
        
        // Atualiza a UI com o histórico
        const historicoItens = document.getElementById('historicoItens');
        if (!historicoItens) return;
        
        if (historico.length === 0) {
            historicoItens.innerHTML = '<div class="text-muted small">Nenhuma busca recente</div>';
            // Esconde o botão de limpar histórico se não houver histórico
            const btnLimpar = document.getElementById('btnLimparHistorico');
            if (btnLimpar) btnLimpar.style.visibility = 'hidden';
            return;
        }
        
        // Limita a 10 itens mais recentes
        const historicoLimitado = historico.slice(0, 10);
        
        // Atualiza a exibição
        atualizarExibicaoHistorico(historicoLimitado);
        
        // Mostra o botão de limpar histórico
        const btnLimpar = document.getElementById('btnLimparHistorico');
        if (btnLimpar) btnLimpar.style.visibility = 'visible';
        
    } catch (error) {
        console.error('Erro ao carregar histórico de buscas:', error);
        const historicoItens = document.getElementById('historicoItens');
        if (historicoItens) {
            historicoItens.innerHTML = '<div class="text-muted small">Erro ao carregar histórico</div>';
        }
    }
}

// Função para limpar o histórico de buscas
function limparHistoricoBuscas() {
    if (confirm('Tem certeza que deseja limpar todo o histórico de buscas?')) {
        try {
            localStorage.removeItem('historicoBuscas');
            
            // Atualiza a UI
            const historicoItens = document.getElementById('historicoItens');
            if (historicoItens) {
                historicoItens.innerHTML = '<div class="text-muted small">Nenhuma busca recente</div>';
            }
            
            // Mostrar mensagem de sucesso
            const mensagem = document.createElement('div');
            mensagem.className = 'alert alert-success alert-dismissible fade show mt-3';
            mensagem.role = 'alert';
            mensagem.innerHTML = `
                Histórico de buscas limpo com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            `;
            
            const container = document.querySelector('#realtime .container');
            if (container) {
                container.insertBefore(mensagem, container.firstChild);
            }
            
            // Esconde o botão de limpar histórico
            const btnLimpar = document.getElementById('btnLimparHistorico');
            if (btnLimpar) btnLimpar.style.visibility = 'hidden';
            
        } catch (error) {
            console.error('Erro ao limpar histórico de buscas:', error);
            mostrarAviso('Erro ao limpar o histórico de buscas.', 'danger');
        }
    }
}


// Função para exibir mensagens de aviso
function mostrarAviso(mensagem, tipo = 'danger', tempoExibicao = 0) {
    const avisoDiv = document.getElementById('ativoAviso');
    if (avisoDiv) {
        // Limpa qualquer timer existente
        if (avisoDiv.timeoutId) {
            clearTimeout(avisoDiv.timeoutId);
        }
        
        const icon = tipo === 'danger' ? 'exclamation-triangle' : 
                   tipo === 'success' ? 'check-circle' : 
                   tipo === 'warning' ? 'exclamation-triangle' : 'info-circle';
        
        // Adiciona classes de animação
        avisoDiv.className = `alert alert-${tipo} d-flex align-items-center fade show`;
        avisoDiv.innerHTML = `
            <i class="bi bi-${icon} me-2"></i>
            <div class="flex-grow-1">${mensagem}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        `;
        avisoDiv.classList.remove('d-none');
        
        // Rola até a mensagem de aviso
        avisoDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Configura o fechamento automático se um tempo for especificado
        if (tempoExibicao > 0) {
            avisoDiv.timeoutId = setTimeout(() => {
                avisoDiv.classList.remove('show');
                setTimeout(() => {
                    avisoDiv.classList.add('d-none');
                }, 150); // Tempo da animação de fade out
            }, tempoExibicao);
        }
    } else {
        // Fallback para alerta padrão se o elemento não for encontrado
        alert(mensagem);
    }
}

// Função para exibir os dados do ativo
function exibirDadosAtivo(dados) {
    const dadosAtivo = dados.dados || {};
    const dadosEspecificos = dados.dados_especificos || {};
    const resultadoDiv = document.getElementById('resultadoAtivo');
    
    // Mostra a seção de resultados com animação
    if (resultadoDiv) {
        resultadoDiv.classList.remove('d-none');
        resultadoDiv.style.opacity = '0';
        resultadoDiv.style.transform = 'translateY(20px)';
        
        // Anima a entrada
        setTimeout(() => {
            resultadoDiv.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            resultadoDiv.style.opacity = '1';
            resultadoDiv.style.transform = 'translateY(0)';
        }, 50);
    }
    
    // Função para atualizar um elemento com animação
    function atualizarElemento(id, valor, formatter = null, prefixo = '', sufixo = '') {
        const element = document.getElementById(id);
        if (element) {
            // Adiciona classe de carregamento
            element.classList.add('placeholder-wave');
            element.style.minWidth = '80px';
            element.style.minHeight = '1.5em';
            element.innerHTML = '&nbsp;';
            
            // Simula um atraso para a animação
            setTimeout(() => {
                element.classList.remove('placeholder-wave');
                element.style.minWidth = '';
                element.style.minHeight = '';
                element.textContent = formatter ? 
                    formatter(valor) : 
                    (prefixo + (valor !== undefined && valor !== null ? valor : '-') + sufixo);
            }, 150);
        }
    }
    
    // Função para animar valores numéricos
    function animarValor(elemento, valor, prefixo = '', sufixo = '') {
        if (!elemento) return;
        
        const atual = parseFloat(elemento.getAttribute('data-valor') || '0');
        const alvo = parseFloat(valor) || 0;
        const duracao = 800; // ms
        const fps = 60;
        const frameDuration = 1000 / fps;
        const totalFrames = Math.round(duracao / frameDuration);
        let frame = 0;
        
        // Salva o valor alvo no elemento
        elemento.setAttribute('data-valor', alvo);
        
        // Limpa qualquer animação anterior
        if (elemento.animacaoValor) {
            cancelAnimationFrame(elemento.animacaoValor);
        }
        
        const animar = () => {
            frame++;
            const progresso = frame / totalFrames;
            const valorAtual = atual + (alvo - atual) * easeOutQuad(progresso);
            
            // Formata o valor com o prefixo e sufixo
            elemento.textContent = `${prefixo}${formatarNumero(valorAtual, 2)}${sufixo}`;
            
            if (frame < totalFrames) {
                elemento.animacaoValor = requestAnimationFrame(animar);
            }
        };
        
        // Inicia a animação
        animar();
    }
    
    // Função de easing para animação suave
    function easeOutQuad(t) {
        return t * (2 - t);
    }
    
    // Atualiza os dados básicos com animação
    atualizarElemento('ativoNome', dadosAtivo.nome);
    atualizarElemento('ativoTicker', dadosAtivo.ticker);
    
    // Preço com animação especial
    const precoElement = document.getElementById('ativoPreco');
    if (precoElement && dadosAtivo.preco_atual !== undefined) {
        precoElement.classList.add('placeholder-wave');
        precoElement.style.minWidth = '120px';
        precoElement.style.minHeight = '2.5rem';
        precoElement.innerHTML = '&nbsp;';
        
        setTimeout(() => {
            precoElement.classList.remove('placeholder-wave');
            precoElement.style.minWidth = '';
            precoElement.style.minHeight = '';
            
            // Anima o valor do preço
            animarValor(precoElement, dadosAtivo.preco_atual, 
                       dadosAtivo.moeda === 'BRL' ? 'R$ ' : '$ ');
        }, 200);
    }
    
    // Atualiza a variação com animação
    const variacao = parseFloat(dadosAtivo.variacao_dia) || 0;
    const variacaoElement = document.getElementById('ativoVariacao');
    if (variacaoElement) {
        variacaoElement.innerHTML = '&nbsp;';
        variacaoElement.className = 'badge placeholder-wave';
        
        setTimeout(() => {
            let classeCor, icone;
            
            if (variacao > 0) {
                classeCor = 'bg-success';
                icone = 'bi-arrow-up';
            } else if (variacao < 0) {
                classeCor = 'bg-danger';
                icone = 'bi-arrow-down';
            } else {
                classeCor = 'bg-secondary';
                icone = 'bi-dash';
            }
            
            // Aplica as classes de animação
            variacaoElement.className = `badge ${classeCor} animate__animated animate__pulse`;
            variacaoElement.innerHTML = `<i class="bi ${icone} me-1"></i>${Math.abs(variacao).toFixed(2)}%`;
            
            // Remove as classes de animação após a conclusão
            setTimeout(() => {
                variacaoElement.classList.remove('animate__animated', 'animate__pulse');
            }, 1000);
            
        }, 250);
    }
    
    // Atualiza o tipo de ativo com animação
    if (dadosAtivo.tipo) {
        const tipoElement = document.getElementById('ativoTipo');
        if (tipoElement) {
            tipoElement.className = 'badge placeholder-wave';
            tipoElement.innerHTML = '&nbsp;';
            
            setTimeout(() => {
                const tipoClasses = {
                    'Ação': 'bg-primary',
                    'FII': 'bg-success',
                    'ETF': 'bg-info',
                    'Criptomoeda': 'bg-warning',
                    'Moeda': 'bg-secondary'
                };
                
                // Adiciona animação de fade in
                tipoElement.className = `badge ${tipoClasses[dadosAtivo.tipo] || 'bg-secondary'} animate__animated animate__fadeIn`;
                tipoElement.textContent = dadosAtivo.tipo;
                
                // Remove a classe de animação após a conclusão
                setTimeout(() => {
                    tipoElement.classList.remove('animate__animated', 'animate__fadeIn');
                }, 1000);
            }, 200);
        }
    }
    
    // Atualiza a data de atualização
    const ativoAtualizacao = document.getElementById('ativoAtualizacao');
    if (ativoAtualizacao) {
        ativoAtualizacao.textContent = dadosAtivo.ultima_atualizacao ? 
            new Date(dadosAtivo.ultima_atualizacao).toLocaleString('pt-BR') : 'Agora mesmo';
    }
    
    // Atualiza o preço médio no formulário
    const precoMedioInput = document.getElementById('precoMedio');
    if (precoMedioInput && dadosAtivo.preco_atual) {
        precoMedioInput.value = parseFloat(dadosAtivo.preco_atual).toFixed(2);
    }
    
    // Atualiza o campo ticker no formulário
    const tickerInput = document.getElementById('tickerAtivo');
    if (tickerInput && dadosAtivo.ticker) {
        tickerInput.value = dadosAtivo.ticker;
    }
    
    // Atualiza os dados adicionais do ativo
    const moeda = dadosAtivo.moeda === 'BRL' ? 'R$ ' : '$ ';
    
    // Preço mínimo do dia
    if (dadosAtivo.min_dia !== undefined) {
        atualizarElemento('ativoMinDia', dadosAtivo.min_dia, null, moeda);
    }
    
    // Preço máximo do dia
    if (dadosAtivo.max_dia !== undefined) {
        atualizarElemento('ativoMaxDia', dadosAtivo.max_dia, null, moeda);
    }
    
    // Preço de abertura
    if (dadosAtivo.abertura !== undefined) {
        atualizarElemento('ativoAbertura', dadosAtivo.abertura, null, moeda);
    }
    
    // Fechamento anterior
    if (dadosAtivo.fechamento_anterior !== undefined) {
        atualizarElemento('ativoFechamentoAnterior', dadosAtivo.fechamento_anterior, null, moeda);
    }
    
    // Volume
    if (dadosAtivo.volume !== undefined) {
        atualizarElemento('ativoVolume', dadosAtivo.volume, formatarNumero);
    }
    
    // Volume médio
    if (dadosAtivo.volume_medio !== undefined) {
        atualizarElemento('ativoVolumeMedio', dadosAtivo.volume_medio, formatarNumero);
    }
    
    // Valor de mercado
    if (dadosAtivo.market_cap !== undefined) {
        atualizarElemento('ativoMarketCap', dadosAtivo.market_cap, formatarMoeda, '', ' ' + dadosAtivo.moeda);
    }
    
    // Rola para a seção de resultados após um pequeno atraso
    setTimeout(() => {
        if (resultadoDiv) {
            resultadoDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 300);
    
    // Cria o gráfico de histórico de preços
    console.log('Dados recebidos para o gráfico:', dados.grafico);
    if (dados.grafico && Array.isArray(dados.grafico) && dados.grafico.length > 0) {
        console.log('Criando gráfico com', dados.grafico.length, 'itens');
        criarGraficoHistorico(dados.grafico, dadosAtivo.moeda || 'BRL');
    } else {
        console.warn('Nenhum dado de gráfico disponível ou formato inválido');
        const graficoContainer = document.getElementById('graficoAtivo');
        if (graficoContainer) {
            graficoContainer.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center py-5">
                    <i class="bi bi-graph-up text-muted" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    <div class="mt-3 text-muted">Dados históricos não disponíveis</div>
                </div>
            `;
        }
    }
}
// Função para criar o gráfico de histórico de preços
function criarGraficoHistorico(dados, moeda) {
    const container = document.getElementById('graficoAtivo');
    if (!container) return;
    
    // Mostra o indicador de carregamento estilizado
    container.innerHTML = `
        <div class="d-flex flex-column justify-content-center align-items-center" style="height: 300px;">
            <div class="chart-loading-spinner mb-3"></div>
            <div class="text-muted">Carregando dados históricos...</div>
        </div>
    `;
    
    // Adia a criação do gráfico para garantir uma transição suave
    setTimeout(() => {
        // Adiciona uma animação de fade in para o container
        container.style.opacity = '0';
        container.style.transition = 'opacity 0.3s ease';
        
        // Força o navegador a renderizar o estado inicial
        void container.offsetWidth;
        
        // Inicia a animação
        container.style.opacity = '1';
        try {
            // Limpa o container
            container.innerHTML = '';
            
            if (!dados || dados.length === 0) {
                container.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center py-5">
                        <i class="bi bi-graph-up text-muted" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        <div class="mt-3 text-muted">Dados históricos não disponíveis</div>
                    </div>
                `;
                return;
            }
            
            // Prepara os dados para o gráfico
            const datas = [];
            const precos = [];
            
            dados.forEach(item => {
                if (item.data && item.preco) {
                    datas.push(item.data);
                    precos.push(parseFloat(item.preco));
                }
            });
            
            if (datas.length === 0) {
                container.innerHTML = `
                    <div class="d-flex flex-column justify-content-center align-items-center text-muted" style="height: 250px;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mt-2 mb-0">Dados históricos inválidos</p>
                    </div>
                `;
                return;
            }
            
            // Cria o gráfico
            const trace = {
                x: datas,
                y: precos,
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: '#4e73df',
                    width: 2,
                    shape: 'spline',
                    smoothing: 0.3
                },
                fill: 'tozeroy',
                fillcolor: 'rgba(78, 115, 223, 0.1)'
            };
            
            const layout = {
                title: {
                    text: 'Histórico de Preços',
                    font: {
                        size: 18,
                        color: '#495057',
                        family: 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                    },
                    x: 0.05,
                    xanchor: 'left',
                    y: 0.95,
                    yanchor: 'top'
                },
                xaxis: {
                    title: {
                        text: 'Data',
                        font: {
                            size: 12,
                            color: '#6c757d'
                        }
                    },
                    showgrid: true,
                    gridcolor: 'rgba(0, 0, 0, 0.05)',
                    zeroline: false,
                    showline: true,
                    linecolor: 'rgba(0, 0, 0, 0.1)',
                    tickfont: {
                        size: 11,
                        color: '#6c757d'
                    },
                    tickformat: '%d/%m/%y'
                },
                yaxis: {
                    title: {
                        text: `Preço (${moeda})`,
                        font: {
                            size: 12,
                            color: '#6c757d'
                        }
                    },
                    showgrid: true,
                    gridcolor: 'rgba(0, 0, 0, 0.05)',
                    zeroline: false,
                    showline: true,
                    linecolor: 'rgba(0, 0, 0, 0.1)',
                    tickfont: {
                        size: 11,
                        color: '#6c757d'
                    },
                    tickprefix: moeda === 'BRL' ? 'R$ ' : '$ ',
                    tickformat: ',.2f'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 60, l: 60, r: 40, b: 60 },
                showlegend: false,
                hovermode: 'closest',
                transition: {
                    duration: 700,
                    easing: 'cubic-in-out'
                },
                hoverlabel: {
                    bgcolor: '#fff',
                    bordercolor: '#dee2e6',
                    font: {
                        family: 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                        size: 12,
                        color: '#212529'
                    }
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['select2d', 'lasso2d'],
                scrollZoom: false
            };
            
            // Cria o gráfico com animação
            Plotly.newPlot(container, [trace], layout, config).then(() => {
                // Adiciona classe para animação de entrada
                container.classList.add('carregado');
            });
            
        } catch (error) {
            console.error('Erro ao criar gráfico:', error);
            container.innerHTML = `
                <div class="d-flex flex-column justify-content-center align-items-center text-danger" style="height: 250px;">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">Erro ao carregar o gráfico</p>
                    <small class="text-muted">${error.message}</small>
                </div>
            `;
        }
    }, 100); // Pequeno atraso para garantir a renderização do indicador
}
// Função para adicionar ativo à carteira
async function adicionarAtivoACarteira() {
    const form = document.getElementById('formAdicionarAtivo');
    if (!form) return;
    
    const ticker = form.querySelector('input[name="ticker"]')?.value.trim();
    const quantidade = form.querySelector('input[name="quantidade"]')?.value.trim();
    const precoMedio = form.querySelector('input[name="preco_medio"]')?.value.trim();
    
    // Validação básica
    if (!ticker) {
        mostrarAviso('Por favor, busque um ativo antes de adicionar à carteira.');
        return;
    }
    
    if (!quantidade || parseFloat(quantidade) <= 0) {
        mostrarAviso('Por favor, insira uma quantidade válida.');
        return;
    }
    
    // Prepara os dados do formulário
    const formData = new FormData(form);
    const dados = Object.fromEntries(formData.entries());
    
    // Se o preço médio não for informado, usa o preço atual
    if (!precoMedio || parseFloat(precoMedio) <= 0) {
        const precoAtual = document.getElementById('ativoPreco')?.textContent;
        if (precoAtual) {
            const precoNumerico = precoAtual.replace(/[^0-9,]/g, '').replace(',', '.');
            if (precoNumerico && !isNaN(parseFloat(precoNumerico))) {
                dados.preco_medio = parseFloat(precoNumerico).toFixed(2);
            }
        }
    }
    
    // Mostra indicador de carregamento
    const btnSubmit = form.querySelector('button[type="submit"]');
    const btnText = btnSubmit?.innerHTML;
    if (btnSubmit) {
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adicionando...';
    }
    
    try {
        // Envia a requisição para o servidor
        const response = await fetch('/adicionar_ativo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(dados)
        });
        
        // Verifica se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error('Resposta inválida do servidor');
        }
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.mensagem || 'Erro ao adicionar ativo à carteira');
        }
        
        if (data.sucesso) {
            // Mostra mensagem de sucesso
            mostrarAviso(data.mensagem || 'Ativo adicionado com sucesso!', 'success');
            
            // Redireciona para a lista de ativos após 1,5 segundos
            setTimeout(() => {
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    window.location.href = '/ativos';
                }
            }, 1500);
        } else {
            throw new Error(data.mensagem || 'Erro ao adicionar ativo à carteira');
        }
    } catch (error) {
        console.error('Erro ao adicionar ativo:', error);
        mostrarAviso(error.message || 'Erro ao adicionar ativo à carteira');
    } finally {
        // Restaura o botão
        if (btnSubmit) {
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = btnText;
        }
    }
}

// Função auxiliar para obter o token CSRF
function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}
</script>
{% endblock %}
{% endblock %}