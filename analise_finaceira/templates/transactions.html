{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Transações Importadas</h2>
        <a href="{{ url_for('upload.upload_file') }}" class="btn btn-primary">
            <i class="bi bi-arrow-left me-1"></i> Voltar para Upload
        </a>
    </div>

    {% if missing_columns %}
    <div class="alert alert-warning mb-4">
        <h5>Atenção: Colunas Faltantes</h5>
        <p>As seguintes colunas obrigatórias estão faltando no banco de dados:</p>
        <ul>
            {% for column in missing_columns %}
            <li>{{ column }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if stats %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Estatísticas</h5>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-0">Total de Transações</h6>
                            <p class="display-6 mb-0">{{ stats.total_transacoes }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title mb-0">Total de Receitas</h6>
                            <p class="display-6 mb-0">R$ {{ utils.format_currency(stats.total_receitas) }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title mb-0">Total de Despesas</h6>
                            <p class="display-6 mb-0">R$ {{ utils.format_currency(stats.total_despesas) }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title mb-0">Período</h6>
                            <p class="mb-0">De {{ stats.periodo.inicio }} até {{ stats.periodo.fim }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title mb-0">Saldo Total</h6>
                            {% set saldo = stats.total_receitas - stats.total_despesas %}
                            <p class="mb-0">R$ {{ utils.format_currency(saldo) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if transactions.empty %}
        <div class="alert alert-info">
            Nenhuma transação encontrada. <a href="{{ url_for('upload.upload_file') }}">Importe um arquivo</a> para começar.
        </div>
    {% else %}
        <div class="row mb-3">
    <div class="col-auto">
        <label for="filtro-ano" class="form-label">Ano:</label>
        <select id="filtro-ano" class="form-select">
            <option value="">Todos</option>
        </select>
    </div>
    <div class="col-auto">
        <label for="filtro-descricao" class="form-label">Descrição:</label>
        <select id="filtro-descricao" class="form-select">
            <option value="">Todas</option>
        </select>
    </div>
    <div class="col-auto">
        <label for="filtro-tipo" class="form-label">Tipo:</label>
        <select id="filtro-tipo" class="form-select">
            <option value="">Todos</option>
        </select>
    </div>
    <div class="col-auto">
        <label for="filtro-categoria" class="form-label">Categoria:</label>
        <select id="filtro-categoria" class="form-select">
            <option value="">Todas</option>
        </select>
    </div>
    <div class="col-auto">
        <label for="filtro-tipo-operacao" class="form-label">Tipo Operação:</label>
        <select id="filtro-tipo-operacao" class="form-select">
            <option value="">Todos</option>
        </select>
    </div>

</div>
<style>
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 1.5rem;
        padding: 0 1rem;
        -webkit-overflow-scrolling: touch;
    }
    
    .table-responsive::-webkit-scrollbar {
        height: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 5px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    #tabela-transacoes {
        width: 100%;
        min-width: 1400px; /* Aumentei para melhor visualização de todas as colunas */
        font-size: 14px;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    #tabela-transacoes th {
        white-space: nowrap;
        padding: 12px;
        min-width: 120px;
        background-color: #343a40;
        color: white;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    
    #tabela-transacoes td {
        padding: 12px;
        min-width: 120px;
        vertical-align: middle;
        border-top: 1px solid #dee2e6;
    }
    
    .badge {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .text-end {
        text-align: right !important;
    }
    
    /* Mantendo a primeira coluna fixa */
    #tabela-transacoes th:first-child,
    #tabela-transacoes td:first-child {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: white;
    }
    
    /* Ajustando as bordas das células fixas */
    #tabela-transacoes th:first-child {
        border-right: 1px solid #dee2e6;
    }
    
    #tabela-transacoes td:first-child {
        border-right: 1px solid #dee2e6;
    }
</style>

<div class="table-responsive">
            <table id="tabela-transacoes" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th class="text-end">Valor</th>
                        <th>Tipo</th>
                        <th>Tipo Operação</th>
                        <th>Categoria</th>
                        <th>Preço</th>
                        <th>Quantidade</th>
                        <th>Taxa</th>
                        <th>Ativo</th>
                        <th>Forma de Pagamento</th>
                        <th>Indicador 1</th>
                        <th>Indicador 2</th>
                    </tr>
                </thead>
                <tbody>
                    {% for _, row in transactions.iterrows() %}
                        <tr>
                            <td>{{ row.get('data', '') }}</td>
                            <td>{{ row.get('descricao', '') }}</td>
                            <td class="text-end">
                                {% set valor = row.get('valor') %}
                                {% if valor is not none %}
                                    <span class="{% if valor < 0 %}text-danger{% else %}text-success{% endif %}">
                                        R$ {{ utils.format_currency(valor) }}
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td data-tipo="{{ row.get('tipo', '') }}">
                                <span class="badge {% if row.get('tipo', '').lower() == 'receita' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ row.get('tipo', '') }}
                                </span>
                            </td>
                            <td>{{ row.get('tipo_operacao', '-') }}</td>
                            <td>{{ row.get('categoria', '-') }}</td>
                            <td class="text-end">
                                {% set preco = row.get('preco') %}
                                {% if preco is not none %}
                                    R$ {{ "%.2f"|format(preco) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% set quantidade = row.get('quantidade') %}
                                {% if quantidade is not none %}
                                    {{ "%.2f"|format(quantidade) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% set taxa = row.get('taxa') %}
                                {% if taxa is not none %}
                                    {{ "%.2f"|format(taxa) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ row.get('ativo', '-') }}</td>
                            <td>{{ row.get('forma_pagamento', '-') }}</td>
                            <td>{{ row.get('indicador1', '-') }}</td>
                            <td>{{ row.get('indicador2', '-') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-active">
                        <td colspan="2"><strong>Total</strong></td>
                        <td class="text-end">
                            <strong>R$ {{ utils.format_currency(transactions['valor'].sum()) }}</strong>
                        </td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
    var table = $('#tabela-transacoes').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
        },
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100, 250, 500],
        order: [[0, 'desc']],
        responsive: true
    });
    // Filtros dropdown para cada coluna
    function uniqueSorted(colIdx, parser) {
        var values = new Set();
        table.column(colIdx).data().each(function(value) {
            if (parser) value = parser(value);
            if(value && value.trim() !== "") values.add(value.trim());
        });
        return Array.from(values).sort();
    }
    // Ano (Data)
    var anos = uniqueSorted(0, function(v) { return v ? v.substring(0,4) : ''; });
    $.each(anos, function(i, ano) {
        $('#filtro-ano').append($('<option>', { value: ano, text: ano }));
    });
    $('#filtro-ano').on('change', function() {
        var val = $(this).val();
        table.column(0).search(val ? '^'+val : '', true, false).draw();
    });
    // Descrição
    var descricoes = uniqueSorted(1);
    $.each(descricoes, function(i, desc) {
        $('#filtro-descricao').append($('<option>', { value: desc, text: desc }));
    });
    $('#filtro-descricao').on('change', function() {
        var val = $.fn.dataTable.util.escapeRegex($(this).val());
        table.column(1).search(val ? '^'+val+'$' : '', true, false).draw();
    });
    // Tipo
    // Corrigir: pegar apenas o texto do atributo data-tipo para o filtro de Tipo
    var tipos = new Set();
    table.column(3).nodes().each(function(cell) {
        var tipo = $(cell).attr('data-tipo');
        if(tipo) tipos.add(tipo.trim());
    });
    tipos = Array.from(tipos).sort();
    $.each(tipos, function(i, tipo) {
        $('#filtro-tipo').append($('<option>', { value: tipo, text: tipo }));
    });
    // Busca personalizada para a coluna Tipo
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var filtroTipo = $('#filtro-tipo').val();
        if (!filtroTipo) return true;
        var tipoCelula = table.column(3).nodes()[dataIndex].getAttribute('data-tipo');
        return tipoCelula && tipoCelula.trim().toLowerCase() === filtroTipo.trim().toLowerCase();
    });
    $('#filtro-tipo').on('change', function() {
        table.draw();
    });

    // Busca personalizada para a coluna Tipo Operação
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var filtroTipoOperacao = $('#filtro-tipo-operacao').val();
        if (!filtroTipoOperacao) return true;
        var tipoOperacao = data[4]; // índice da coluna tipo_operacao
        return tipoOperacao && tipoOperacao.trim().toLowerCase() === filtroTipoOperacao.trim().toLowerCase();
    });
    $('#filtro-tipo-operacao').on('change', function() {
        table.draw();
    });
    
    // Categoria
    var categorias = uniqueSorted(4);
    $.each(categorias, function(i, cat) {
        $('#filtro-categoria').append($('<option>', { value: cat, text: cat }));
    });
    $('#filtro-categoria').on('change', function() {
        var val = $.fn.dataTable.util.escapeRegex($(this).val());
        table.column(4).search(val ? '^'+val+'$' : '', true, false).draw();
    });
    
    // Tipo Operação
    var tipos_operacao = uniqueSorted(5);
    $.each(tipos_operacao, function(i, tipo) {
        $('#filtro-tipo-operacao').append($('<option>', { value: tipo, text: tipo }));
    });
    $('#filtro-tipo-operacao').on('change', function() {
        var val = $.fn.dataTable.util.escapeRegex($(this).val());
        table.column(5).search(val ? '^'+val+'$' : '', true, false).draw();
    });
});
</script>
{% endblock %}
