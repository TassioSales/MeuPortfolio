{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <h2 class="fw-bold text-dark">
            <i class="bi bi-graph-up-arrow me-2 text-primary"></i>Investimentos
        </h2>
        <p class="text-muted">Acompanhe a performance da sua carteira de ativos.</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'investment_add' %}" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-lg me-1"></i>Novo Investimento
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small fw-bold mb-2">Total Investido</h6>
                <h3 class="fw-bold text-dark mb-0">R$ {{ total_invested|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small fw-bold mb-2">Valor Atual</h6>
                <h3 class="fw-bold text-primary mb-0">R$ {{ total_current_value|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small fw-bold mb-2">Rentabilidade</h6>
                <h3 class="fw-bold {% if roi >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                    {% if roi >= 0 %}+{% endif %}R$ {{ roi|floatformat:2 }}
                    <small class="fs-6 text-muted ms-1">({{ roi_pct|floatformat:2 }}%)</small>
                </h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Chart & Search -->
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h5 class="card-title fw-bold mb-3 text-dark">Distribuição</h5>
                        <div style="max-height: 250px; position: relative;">
                            <canvas id="portfolioPieChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 ps-md-4">
                        <h5 class="card-title fw-bold mb-3 text-dark">Consultar Cotação</h5>
                        <div class="input-group mb-3">
                            <input type="text" id="tickerInput" class="form-control" placeholder="Ex: PETR4, ITUB4">
                            <button class="btn btn-outline-primary" type="button" id="searchButton">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>

                        <div id="searchLoading" class="d-none text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2 text-muted">Buscando...</span>
                        </div>

                        <div id="searchResult" class="d-none p-3 bg-light rounded border">
                            <!-- Conteúdo injetado via JS -->
                        </div>

                        <div id="searchError" class="d-none alert alert-danger mt-3 py-2 small">
                            <i class="bi bi-exclamation-circle me-1"></i>Ativo não encontrado.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="col-md-12">
        <div class="card shadow-sm border-0 overflow-hidden">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-3 ps-4 text-uppercase text-muted small fw-bold">Ativo</th>
                                <th class="py-3 text-uppercase text-muted small fw-bold">Qtd.</th>
                                <th class="py-3 text-uppercase text-muted small fw-bold">Preço Médio</th>
                                <th class="py-3 text-uppercase text-muted small fw-bold">Total Investido</th>
                                <th class="py-3 text-uppercase text-muted small fw-bold">Preço Atual</th>
                                <th class="py-3 text-uppercase text-muted small fw-bold">Valor Atual</th>
                                <th class="py-3 pe-4 text-end text-uppercase text-muted small fw-bold">Lucro/Prejuízo
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in portfolio %}
                            <tr style="transition: background-color 0.2s;">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center me-3 fw-bold shadow-sm border"
                                            style="width: 42px; height: 42px; font-size: 0.9rem;">
                                            {{ item.investment.symbol|slice:":2" }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ item.investment.symbol }}</div>
                                            <div class="text-muted small"
                                                style="font-size: 0.8rem; letter-spacing: 0.3px;">
                                                {% if item.investment.name %}
                                                {{ item.investment.name|truncatechars:25 }}
                                                {% else %}
                                                {{ item.investment.symbol }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-medium text-secondary">{{ item.investment.quantity|floatformat:"-4" }}
                                </td>
                                <td class="text-secondary">R$ {{ item.investment.purchase_price|floatformat:2 }}</td>
                                <td class="text-secondary fw-medium">R$ {{ item.invested_value|floatformat:2 }}</td>
                                <td class="fw-medium">R$ {{ item.current_price|floatformat:2 }}</td>
                                <td class="fw-bold text-dark">R$ {{ item.current_value|floatformat:2 }}</td>
                                <td class="pe-4 text-end">
                                    {% if item.profit_loss >= 0 %}
                                    <span class="fw-bold text-success d-block mb-1">+R$ {{ item.profit_loss|floatformat:2 }}</span>
                                    <span
                                        class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-2">
                                        <i class="bi bi-arrow-up-short"></i>{{ item.profit_loss_pct|floatformat:2 }}%
                                    </span>
                                    {% else %}
                                    <span class="fw-bold text-danger d-block mb-1">R$ {{ item.profit_loss|floatformat:2 }}</span>
                                    <span
                                        class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-2">
                                        <i class="bi bi-arrow-down-short"></i>{{ item.profit_loss_pct|floatformat:2 }}%
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="bi bi-graph-up fs-1 d-block mb-3 opacity-50"></i>
                                        <p class="mb-2">Nenhum investimento encontrado.</p>
                                        <a href="{% url 'investment_add' %}"
                                            class="btn btn-sm btn-outline-primary mt-2">
                                            Adicionar primeiro ativo
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js + Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfico de Pizza
    const ctx = document.getElementById('portfolioPieChart');
    if (ctx) {
        try {
            const labels = JSON.parse('{{ chart_labels|safe }}'.replace(/'/g, '"') || '[]');
            const data = JSON.parse('{{ chart_data|safe }}'.replace(/'/g, '"') || '[]');

            if (labels.length > 0 && data.length > 0) {
                new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#198754', '#ffc107'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { boxWidth: 12 }
                            }
                        }
                    }
                });
            } else {
                ctx.style.display = 'none';
                ctx.parentElement.innerHTML = '<p class="text-center text-muted mt-5 small">Sem dados para exibir</p>';
            }
        } catch (e) {
            console.error("Erro no gráfico:", e);
        }
    }

    // Busca de cotações
    const searchButton = document.getElementById('searchButton');
    const tickerInput = document.getElementById('tickerInput');
    const loadingDiv = document.getElementById('searchLoading');
    const resultDiv = document.getElementById('searchResult');
    const errorDiv = document.getElementById('searchError');

    function performSearch() {
        const ticker = tickerInput.value.trim().toUpperCase();
        if (!ticker) return;

        loadingDiv.classList.remove('d-none');
        resultDiv.classList.add('d-none');
        errorDiv.classList.add('d-none');

        fetch(`{% url 'search_ticker' %}?ticker=${ticker}`)
            .then(r => r.json())
            .then(d => {
                loadingDiv.classList.add('d-none');

                if (d.error) {
                    errorDiv.classList.remove('d-none');
                    return;
                }

                const fmt = (val) => (val == null) ? '-' : val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // Variação diária
                let changeHtml = '-';
                let colorClass = 'text-muted';
                if (d.change_percent !== undefined && d.change_percent !== null) {
                    colorClass = d.change_percent >= 0 ? 'text-success' : 'text-danger';
                    const sign = d.change_percent >= 0 ? '+' : '';
                    changeHtml = `${sign}${fmt(d.change_percent)}%`;
                }

                const extraInfo = `
                    <div class="mt-3 pt-3 border-top">
                        <div class="row text-center">
                            <div class="col-4 border-end">
                                <div class="text-muted text-uppercase small">Variação</div>
                                <div class="${colorClass} fw-bold">${changeHtml}</div>
                            </div>
                            <div class="col-4 border-end">
                                <div class="text-muted text-uppercase small">Dia (Min/Máx)</div>
                                <div class="text-dark fw-medium small">${fmt(d.day_low)} / ${fmt(d.day_high)}</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted text-uppercase small">52 Semanas</div>
                                <div class="text-dark fw-medium small">${fmt(d.year_low)} / ${fmt(d.year_high)}</div>
                            </div>
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="fw-bold mb-0">${d.symbol}</h6>
                            <small class="text-muted">${d.name || ''}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success mb-1">Cotação Atual</span>
                            <div class="fw-bold fs-5 text-dark">R$ ${fmt(d.price)}</div>
                        </div>
                    </div>
                    ${extraInfo}
                `;
                resultDiv.classList.remove('d-none');
            })
            .catch(err => {
                console.error(err);
                loadingDiv.classList.add('d-none');
                errorDiv.classList.remove('d-none');
            });
    }

    if (searchButton) searchButton.addEventListener('click', performSearch);
    if (tickerInput) {
        tickerInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') performSearch();
        });
    }
</script>
{% endblock %}